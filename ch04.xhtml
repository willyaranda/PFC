<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Capítulo 4. Arquitectura interna</title><link rel="stylesheet" type="text/css" href="docbook.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"/><link rel="prev" href="ch03s02.xhtml" title="Interna: Entre el UA y el NS"/><link rel="next" href="ch04s02.xhtml" title="Flujos de trabajo"/></head><body><header><div class="navheader"><table style="width: 100%; "><tr><th style="text-align: center; " colspan="3">Capítulo 4. Arquitectura interna</th></tr><tr><td style="width: 20%; text-align: left; "><a accesskey="p" href="ch03s02.xhtml">Anterior</a> </td><th style="width: 60%; text-align: center; "> </th><td style="width: 20%; text-align: right; "> <a accesskey="n" href="ch04s02.xhtml">Siguiente</a></td></tr></table><hr/></div></header><section xml:lang="es" class="chapter" id="architecture"><div class="titlepage"><div><div><h1 class="title">Capítulo 4. Arquitectura interna</h1></div></div></div><div class="toc"><div class="toc-title">Tabla de contenidos</div><ul><li><span class="section"><a href="ch04.xhtml#idp839488">Tipos de servidor</a></span><ul><li><span class="section"><a href="ch04.xhtml#idp842000">NS-UA-WS</a></span></li><li><span class="section"><a href="ch04.xhtml#idp852464">NS-UA-UDP</a></span></li><li><span class="section"><a href="ch04.xhtml#idp855936">NS_Proxy_UDP</a></span></li><li><span class="section"><a href="ch04.xhtml#idp144656">NS-AS</a></span></li><li><span class="section"><a href="ch04.xhtml#idp154448">NS-MSG-Monitor</a></span></li><li><span class="section"><a href="ch04.xhtml#idp156528">Colas de mensajes, o Message Queue</a></span></li><li><span class="section"><a href="ch04.xhtml#idp167280">Base de datos, NO-SQL (MongoDB)</a></span></li></ul></li><li><span class="section"><a href="ch04s02.xhtml">Flujos de trabajo</a></span><ul><li><span class="section"><a href="ch04s02.xhtml#idp170560">Registros de dispositivos/aplicaciones</a></span></li><li><span class="section"><a href="ch04s02.xhtml#idp177936">Aceptación de notificación</a></span></li><li><span class="section"><a href="ch04s02.xhtml#idp186800">Envío de notificación al dispositivo: WebSocket</a></span></li><li><span class="section"><a href="ch04s02.xhtml#idp193696">Envío de notificación al dispositivo: UDP</a></span></li><li><span class="section"><a href="ch04s02.xhtml#idp303680">Confirmación de recepción</a></span></li></ul></li></ul></div><p>
    El capítulo tiene como finalidad explicar cómo se ha organizado internamente el servidor de notificaciones central y cómo interactúan las diferentes partes o instancias entre ellas para que las notificaciones sean tratadas correctamente, desde el momento en que son recibidas hasta cuando el teléfono va a procesarlas y tiene que dar la confirmación de recepción.
  </p><p>
    Pero antes de explicar el funcionamiento y los diferentes mensajes que se intercambian, se explicará los diferentes actores que están en funcionamiento repartidos por todo el servidor.
  </p><div class="figure" id="idp837216"><div class="figure-title">Figura 4.1. Esquema general de la arquitectura</div><div class="figure-contents"><div style="text-align: justify; " class="mediaobject"><table style="border: 0; width: 567; cellpadding: 0; cellspacing: 0;"><tr><td style="text-align: justify; "><img style="text-align: justify; width: 567; " src="../../resources/whole-arch.png" alt="Esquema general de la arquitectura"/></td></tr></table></div></div></div><br class="figure-break"/><section class="section" id="idp839488"><div class="titlepage"><div><div><h2 class="title" style="clear: both">Tipos de servidor</h2></div></div></div><p>
      Para poder escalar tanto horizontal como verticalmente sin tener ningún límite, la infraestructura del servidor de notificaciones central ha sido dividida en diferentes instancias o cajas, cada una dedicada a una función en particular, y que a su vez son independientes del resto, comunicándose sólo por mensajería.
    </p><div style="margin-left: 0.5in; margin-right: 0.5in;" class="note"><h3 class="title">Nota</h3><p>Los nombres de cada caja siguen la nomenclatura: <code class="code">NS-&lt;tipo_de_cliente&gt;</code>.</p></div><section class="section" id="idp842000"><div class="titlepage"><div><div><h3 class="title">NS-UA-WS</h3></div></div></div><p>
        Este servidor es el encargado de ejercer como frontend para los dispositivos móviles, exponiendo una serie de APIs para que los diferentes agentes de usuario (o <code class="code">UA</code>) puedan utilizarlo. En concreto, posee dos interfaces, una HTTP y otra como WebSockets.
      </p><p>
        Las dos interfaces son:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="formalpara-title">HTTP. </span>
              Sirve para pedir un token válido para el agente de usuario, único, que sirve para identificar a cada dispositivo. Este token puede ser recogido llamando al método <code class="code">HTTP Get</code> a la url <code class="code">https://push.telefonica.com/token</code>
            </p></li><li class="listitem"><p><span class="formalpara-title">WebSocket. </span>
              Diseñado para ejercer como canal de comunicación bidireccional entre el agente de usuario y el servidor de notificaciones. Es la conexión por la cual se realizan los registros y se envían las notificaciones.
            </p></li></ul></div><p>
        Y sus principales cometidos son:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Guardar en la base de datos de MongoDB todos los nodos registrados y las aplicaciones, además de tener que recogerlos en determinado momento.
          </p></li><li class="listitem"><p>
            Suscribirse a una cola de mensajes creada específicamente para él, por el cual le llegan las notificaciones de que tiene que enviar un mensaje a un dispositivo.
          </p></li><li class="listitem"><p>
            Proveer las dos interfaces explicadas anteriormente, que sirven como nexo de comunicación entre los dispositivos y el servidor de notificaciones.
          </p></li></ul></div></section><section class="section" id="idp852464"><div class="titlepage"><div><div><h3 class="title">NS-UA-UDP</h3></div></div></div><p>
        Este servidor es el responsable de intermediar entre el servidor de notificaciones central y el servidor de wakeup, o <code class="code">NS_Proxy_UDP</code> que está desplegado en el interior de cada operadora móvil.
      </p><p>
        Al igual que el servidor anterior, el <code class="code">NS-UA-WS</code>, este también está escuchando una cola determinada, llamada <code class="code">UDP</code>, para que cada vez que llegue un mensaje, lo procese, recupere de la base de datos MongoDB la información necesaria y pueda enviar al servidor <code class="code">NS_Proxy_UDP</code> un mensaje HTTP para que éste último despierte al teléfono con un pequeño paquete UDP.
      </p></section><section class="section" id="idp855936"><div class="titlepage"><div><div><h3 class="title">NS_Proxy_UDP</h3></div></div></div><p>
        Este servidor es un proxy entre el complejo central del servidor de notificaciones y los clientes. Este servicio recibe peticiones a través de un puerto HTTP estándar, y manda datagramas UDP o paquetes TCP a los dispositivos dentro de la red móvil con el propósito de despertarles y que se conecten a la infraestructura central. Esta instancia debe estar instalada dentro de la zona privada de la operadora, y tener visión directa de todos los terminales móviles en dicha red.
      </p></section><section class="section" id="idp144656"><div class="titlepage"><div><div><h3 class="title">NS-AS</h3></div></div></div><p>
        Esta instancia, es el front-end para los servidores de aplicaciones. Proporciona una interfaz HTTP Post para poder recibir notificaciones.
      </p><p>
        La interfaz expone la ruta <code class="code">/notify</code>, en la cual una vez recibido, se procesan los mensajes, comprobando si son correctos, si están firmados y son válidos (recogiendo la clave pública desde la base de datos central) y realizando dos pasos diferentes:
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
            Introducir el mensaje en la base de datos MongoDB para mantener una persistencia y no perder el mensaje por si ocurre algún error.
          </p></li><li class="listitem"><p>
            Enviar una notificación a la cola <code class="code">newMessages</code>, que indica que se ha recibido una nueva notificación.
          </p></li></ol></div></section><section class="section" id="idp154448"><div class="titlepage"><div><div><h3 class="title">NS-MSG-Monitor</h3></div></div></div><p>
        Es el responsable de recibir los mensajes a través de la cola <code class="code">newMessages</code>, procesarlos, encontrar a quién están dirigidos, y enviarlo a la cola de los servidores que dan servicio a los diferentes dispositivos de forma correcta. Se podría decir que por esta instancia pasan todos los mensajes que tienen que moverse por dentro del complejo sistema del servidor. Además, monitoriza el estado de los mensajes y los re-encola si fuera necesario, así como eliminarlos en un futuro si sobrepasan su tiempo de vida máximo
      </p></section><section class="section" id="idp156528"><div class="titlepage"><div><div><h3 class="title">Colas de mensajes, o Message Queue</h3></div></div></div><p>
        Son varias instancias del sistema de mensajería RabbitMQ que actúa como transportista de mensajes entre todos los diferentes servidores que lo componen.
      </p><p>
        En primer lugar, su función es la de creación de colas, que son alimentadas por un extremo, y consumidas por el otro. La configuración varía según las colas y cuál sea su cometido, pero por ejemplo, se puede encontrar:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><span class="formalpara-title">/newMessages. </span>
              Recibe todos los nuevos mensajes a partir del servidor <code class="code">NS-AS</code>. Los lee el monitor <code class="code">NS-MSG-Monitor</code>.
            </p></li><li class="listitem"><p><span class="formalpara-title">/UDP. </span>
              Una cola que leen todos los servidores de UDP, <code class="code">NS-UA-UDP</code> y que es escrita por el monitor <code class="code">NS-MSG-Monitor</code>.
            </p></li><li class="listitem"><p><span class="formalpara-title">/(serverId). </span>
              Muy similar a la cola <code class="code">/UDP</code>, pero con la diferencia que es leída por los diferentes servidores de WebSockets que hay en la infraestructura, o <code class="code">NS-UA-WS</code>.
            </p></li></ul></div><p>
        Debido a la alta carga, este servidor se despliega en modo cluster, con alta disponibilidad y mirroring de colas entre las diferentes intancias.
      </p></section><section class="section" id="idp167280"><div class="titlepage"><div><div><h3 class="title">Base de datos, NO-SQL (MongoDB)</h3></div></div></div><p>
        Un cluster de instancias de MongoDB es usado para mantener todos los datos persistentes que haya que guardar, como los registros de dispositivos y de aplicaciones, así como mensajes recibidos y los diferentes servidores de wakeup disponibles en las diferentes redes móviles.
      </p></section></section></section><footer><div class="navfooter"><hr/><table style="width: 100%; "><tr><td style="width: 40%; text-align: left; "><a accesskey="p" href="ch03s02.xhtml">Anterior</a> </td><td style="width: 20%; text-align: center; "> </td><td style="width: 40%; text-align: right; "> <a accesskey="n" href="ch04s02.xhtml">Siguiente</a></td></tr><tr><td style="width: 40%; text-align: left; vertical-align: top; ">Interna: Entre el UA y el NS </td><td style="width: 20%; text-align: center; "><a accesskey="h" href="index.xhtml">Inicio</a></td><td style="width: 40%; text-align: right; vertical-align: top; "> Flujos de trabajo</td></tr></table></div></footer></body></html>
