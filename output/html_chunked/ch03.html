<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Chapter 3. Notification server API</title><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><link rel="home" href="index.html" title="Notification Server"><link rel="up" href="index.html" title="Notification Server"><link rel="prev" href="ch02s06.html" title="Mobile Network. Battery comsuption"><link rel="next" href="ch03s02.html" title="API between the User Agent and the Notification Server"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 3. Notification server API</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch02s06.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch03s02.html">Next</a></td></tr></table><hr></div><div lang="en" class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="api"></a>Chapter 3. Notification server API</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="ch03.html#api_wa_ua">API between WebApp and the User Agent</a></span></dt><dt><span class="section"><a href="ch03s02.html">API between the User Agent and the Notification Server</a></span></dt><dt><span class="section"><a href="ch03s03.html">API between the Application Server and the Notification Server</a></span></dt><dt><span class="section"><a href="ch03s04.html">API between the WA and the AS</a></span></dt><dt><span class="section"><a href="ch03s05.html">Tokens</a></span></dt><dd><dl><dt><span class="section"><a href="ch03s05.html#idp262928">WAToken</a></span></dt><dt><span class="section"><a href="ch03s05.html#idp268976">UAToken</a></span></dt><dt><span class="section"><a href="ch03s05.html#idp271360">AppToken</a></span></dt></dl></dd><dt><span class="section"><a href="ch03s06.html">WakeUp</a></span></dt></dl></div><p>
    The Notification Server API is based on the W3C draft:
    <a class="link" href="http://dvcs.w3.org/hg/push/raw-file/default/index.html" target="_top">
      [http://dvcs.w3.org/hg/push/raw-file/default/index.html]
    </a>
  </p><p>
    In order to understand this chapter, we'll present the different actors:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        WebApp (WA):
        <p>
          The user's applications which is normally executed on the
          user device.
        </p></li><li class="listitem">
        User Agent (UA):
        <p>
          Since this protocol born under the Firefox OS umbrella the
          "operating system" layer is known as the User Agent layer, in our case
          is the Gecko engine.
        </p></li><li class="listitem">
        Notification Server (NS):
        <p>
          Centralized infrastructure of the notification
          server platform. This one can be freely deployed by anyone since it's
          open source:
          <a class="link" href="https://github.com/telefonicaid/notification_server" target="_top">
            [https://github.com/telefonicaid/notification_server]
          </a>.
          The protocol also allows to use any server infrastructure the user wants
        </p></li><li class="listitem">
        Application server (AS):
        <p>
          The WA server side. Normally the applications that runs on a
          mobile device use one or more Internet servers.
        </p><p>
          Some of them will be deployed by the same developer as the client application.
        </p><p>
          In our case, this server will be the one which send the notification to
          his clients/users.
        </p></li></ul></div><p>
  </p><p>
    </p><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="450"><tr><td align="center"><img src="resources/actors_and_channels.png" align="middle" width="450"></td></tr></table><p>
  </p><div lang="en" class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="api_wa_ua"></a>API between WebApp and the User Agent</h2></div></div></div><p>
    This API is mainly based on the W3C draft as specified in
    <a class="link" href="http://dvcs.w3.org/hg/push/raw-file/default/index.html" target="_top">
      [http://dvcs.w3.org/hg/push/raw-file/default/index.html]
    </a>
  </p><p>
    With this API the application is able to register itself into the
    Notification Server and recover the public URL to be used as notification
    URL by his Application Server (AS).
  </p><p>
    This API (under the navigator.mozPush object) defines these methods:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        requestURL
      </li><li class="listitem">
        getCurrentURL
      </li></ul></div><p>
    </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="idp195552"></a>navigator.mozPush.requestURL</h4></div></div></div><p>
        This method allows the application to register it self into the
        notification server.
        </p><pre class="programlisting">
        
        navigator.mozPush.requestURL(watoken, pbk)
        
        </pre><p>
      </p><p>
        This method should receive this two parameters:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
            watoken: The WA Token used to identify the user of the application.
            <p>
              The application developer can decide to use the same WAToken for
              all his users or a group of them so the notification will act
              as a broadcast message
            </p><p>
              It's very important to note that this token (mainly if used to
              identify one particular user) SHALL be a secret. It's recommended
              that this token will be generated by the server using a SHA hash
              based on the login details (as an identification cookie).
            </p><p>
              If this parameter is not provided, a randomized one will be
              generated by the UA engine.
            </p></li><li class="listitem">
            pbk: This parameter will contain a RSA Public key coded in BASE64.
            <p>
              This public key will be used by the notification server to
              validate the received messages signature, so the private key
              will be used by the AS to sign the messages.
            </p></li></ul></div><p>
      </p><p>
        It's under definition to send two parameters or only one which will be
        a JSON object:
        </p><pre class="programlisting">
        
        navigator.mozPush.requestURL({
          watoken: &lt;watoken&gt;,
          pbk: &lt;Base64 codified public key&gt;
        })
        
        </pre><p>
      </p><p>
        Finally this method will response asynchronously with the URL to be
        sent to the AS in order to be able to send notifications.
      </p><pre class="programlisting">
        
        var req = navigator.mozPush.requestURL(this.watoken, this.pbk);
        req.onsuccess = function(e) {
          alert("Received URL: " + req.result.url);
        };
        req.onerror = function(e) {
          alert("Error registering app");
        }
        
      </pre></div><p>

    </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="idp204464"></a>navigator.mozPush.getCurrentURL</h4></div></div></div><p>
        This method allows the application to recover a previously requested
        URL to the UA API, so it's not needed to ask for it to the
        notification server.
        </p><pre class="programlisting">
        
        navigator.mozPush.getCurrentURL()
        
        </pre><p>
      </p><p>
        This methods will response asynchronously with the URL to be
        sent to the AS in order to be able to send notifications.
      </p><pre class="programlisting">
        
        var req = navigator.mozPush.getCurrentURL();
        req.onsuccess = function(e) {
          alert("URL = " + req.result.url);
        };
        req.onerror = function(e) {
          alert("Error getting URL");
        }
        
      </pre></div><p>
  </p><p>
    After register the application into the Notification Server, all received
    notification through the given URL will be delivered to all user agents
    which registered the pair (WAToken + PBK).
  </p><p>
    Since the notifications will be received by the UA it's needed a way to
    notify each application. The current specification is using the new
    System Messages infrastructure defined in FirefoxOS.
  </p><p>
    In this case, the application shall register to the "push-notification"
    event handlser:
    </p><pre class="programlisting">
    
    navigator.mozSetMessageHandler("push-notification", function(msg) {
      alert("New Message with body: " + JSON.stringify(msg));
    });
    
    </pre><p>
  </p><p>
    The complete example:
    </p><pre class="programlisting">
      
      var req = navigator.mozPush.requestURL(this.watoken, this.pbk);
      req.onsuccess = function(e) {
        alert("Received URL: " + req.result.url);
        navigator.mozSetMessageHandler("push-notification", function(msg) {
          alert("New Message with body: " + JSON.stringify(msg));
        });
      };
      req.onerror = function(e) {
        alert("Error registering app");
      }
      
    </pre><p>
  </p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch02s06.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ch03s02.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Mobile Network. Battery comsuption </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> API between the User Agent and the Notification Server</td></tr></table></div></body></html>
